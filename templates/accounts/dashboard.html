{% extends 'base.html' %}

{% load static %}

{% block title %}Личный кабинет - Vagvin{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/accounts.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/accounts.js' %}"></script>
{% endblock %}

{% block content %}
    <!-- Dashboard Hero Section -->
    <section class="hero py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <h1>Личный кабинет</h1>
                    <p>Управляйте своим аккаунтом и отслеживайте историю запросов</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Content Section -->
    <section class="py-5">
        <div class="container">
            <div id="alerts-container">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} mb-4">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="row g-4">
                <!-- User Info Card -->
                <div class="col-lg-6">
                    <div class="card shadow-sm p-4 mb-4 h-100">
                        <div class="card-body">
                            <h2 class="mb-4">Ваши данные</h2>
                            <div class="mb-4">
                                <div class="table-responsive">
                                    <table class="table">
                                        <tbody>
                                        <tr>
                                            <td class="fw-bold" style="width: 40%;">Логин</td>
                                            <td>{{ user_data.username }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">
                                                Почта
                                                <i class="fas fa-question-circle text-secondary ms-1"
                                                   data-bs-toggle="tooltip"
                                                   title="Основной email, указанный при регистрации"></i>
                                            </td>
                                            <td>{{ user_data.email }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">
                                                Баланс
                                                <i class="fas fa-question-circle text-secondary ms-1"
                                                   data-bs-toggle="tooltip"
                                                   title="Ваш текущий баланс для оплаты отчетов"></i>
                                            </td>
                                            <td>
                                                <span class="badge bg-success rounded-pill fs-6">{{ user_data.balance }} руб.</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Овердрафт</td>
                                            <td>
                                                <span class="badge bg-success rounded-pill fs-6">{{ user_data.overdraft }} руб.</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Кол-во реф.</td>
                                            <td>{{ user_data.referrals_count }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">
                                                Реф. ссылка
                                                <i class="fas fa-question-circle text-secondary ms-1"
                                                   data-bs-toggle="tooltip"
                                                   title="Ваша реферальная ссылка для приглашения друзей. Получайте 10% от их пополнений"></i>
                                            </td>
                                            <td>
                                                <div class="input-group">
                                                    <input type="text" class="form-control"
                                                           value="{{ user_data.referral_link }}" readonly>
                                                    <button class="btn btn-outline-secondary btn-copy-referral"
                                                            type="button" data-referral-link="{{ user_data.referral_link }}">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">
                                                Доп. почты
                                                <i class="fas fa-question-circle text-secondary ms-1"
                                                   data-bs-toggle="tooltip"
                                                   title="Дополнительные адреса электронной почты для получения отчетов"></i>
                                            </td>
                                            <td>
                                                {% if user_data.additional_emails %}
                                                    <ul class="list-unstyled mb-0">
                                                        {% for email in user_data.additional_emails %}
                                                            <li class="d-flex justify-content-between align-items-center mb-1">
                                                                {{ email }}
                                                                <button class="btn btn-sm btn-outline-danger remove-email" 
                                                                        data-email="{{ email }}"
                                                                        data-url="{% url 'accounts:remove_email' %}">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    Нет дополнительных email
                                                {% endif %}
                                                
                                                {% if user_data.additional_emails|length < 5 %}
                                                    <form id="add-email-form" class="mt-2" data-url="{% url 'accounts:add_email' %}">
                                                        {% csrf_token %}
                                                        <div class="input-group">
                                                            <input type="email" class="form-control form-control-sm" 
                                                                  id="id_email" name="email" 
                                                                  placeholder="Добавить email" required>
                                                            <button type="submit" class="btn btn-sm btn-primary">
                                                                <i class="fas fa-plus"></i>
                                                            </button>
                                                        </div>
                                                    </form>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="support-actions">
                                <a href="https://t.me/VinVaG?text=Здравствуйте.%0AID:%20{{ user_data.id|urlencode }}%0AПочта:%20{{ user_data.email|urlencode }}%0AУ%20меня%20есть%20вопрос%20по%20моему%20аккаунту."
                                   target="_blank"
                                   class="btn btn-primary">
                                    <i class="fas fa-headset me-2"></i>Связаться с поддержкой
                                </a>
                                <a href="https://t.me/VinVaG?text=Здравствуйте.%0AID:%20{{ user_data.id|urlencode }}%0AПочта:%20{{ user_data.email|urlencode }}%0AПрошу%20рассмотреть%20возможность%20возврата%20средств.%0AЗапрашиваемая%20сумма%20возврата:%20"
                                   target="_blank"
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-money-bill-wave me-2"></i>Запрос на возврат
                                </a>
                            </div>

                            <div class="alert alert-info mt-4">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-crown text-warning me-3 fs-4"></i>
                                    <div>
                                        <a href="https://t.me/VinVaG?text=Здравствуйте.%0AID:%20{{ user_data.id|urlencode }}%0AПочта:%20{{ user_data.email|urlencode }}%0AИнтересуют%20специальные%20условия%20при%20пополнении%20от%2010000%20руб."
                                           target="_blank"
                                           class="fw-bold text-decoration-none"
                                           style="color: #1e293b; font-size: 1.1rem;">
                                            Специальные условия при пополнении от 10&nbsp;000&nbsp;₽ — узнать
                                            подробности
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Balance & Payment Card -->
                <div class="col-lg-6">
                    <div class="card shadow-sm p-4 mb-4 h-100">
                        <div class="card-body">
                            <h2 class="mb-4">Пополнение баланса</h2>

                            <!-- Payment Statistics -->
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <div class="dashboard-stat">
                                        <div class="stat-title">Всего пополнений</div>
                                        <div class="stat-value">{{ payments_count }}</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="dashboard-stat">
                                        <div class="stat-title">Сумма пополнений</div>
                                        <div class="stat-value">{{ total_amount }} ₽</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="dashboard-stat">
                                        <div class="stat-title">Последнее пополнение</div>
                                        <div class="stat-value">{% if last_payment %}{{ last_payment.amount|floatformat:2 }}{% else %}0.00{% endif %} ₽</div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mb-4">
                                <a href="{% url 'payments:requisites' %}" class="btn btn-primary">
                                    <i class="fas fa-money-bill-wave me-2"></i>Другие способы оплаты
                                </a>
                            </div>

                            <ul class="nav nav-tabs mb-4" id="paymentTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="robokassa-tab" data-bs-toggle="tab"
                                            data-bs-target="#robokassa" type="button" role="tab"
                                            aria-controls="robokassa" aria-selected="true">
                                        <i class="fas fa-wallet me-2"></i>Robokassa
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="yookassa-tab" data-bs-toggle="tab"
                                            data-bs-target="#yookassa" type="button" role="tab" aria-controls="yookassa"
                                            aria-selected="false">
                                        <i class="fas fa-credit-card me-2"></i>ЮKassa
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="heleket-tab" data-bs-toggle="tab"
                                            data-bs-target="#heleket" type="button" role="tab" aria-controls="heleket"
                                            aria-selected="false">
                                        <i class="fas fa-coins me-2"></i>Crypto
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="paymentTabsContent">
                                <!-- Robokassa Form -->
                                <div class="tab-pane fade show active" id="robokassa" role="tabpanel"
                                     aria-labelledby="robokassa-tab">
                                    <div class="alert alert-info mb-4">
                                        <p class="mb-0">Быстрый и безопасный способ оплаты.
                                            Поддерживаются банковские карты и электронные кошельки. Система
                                            автоматически добавит
                                            комиссию 10% к указанной вами сумме.</p>
                                    </div>
                                    <form id="robokassa-form" data-url="{% url 'payments:robokassa_initiate' %}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="robokassa-amount" class="form-label fw-bold">Сумма пополнения
                                                (руб.)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="robokassa-amount"
                                                       min="100" step="100" placeholder="Например, 1000" required>
                                                <button type="submit" class="btn btn-primary">Пополнить
                                                </button>
                                            </div>
                                            <small class="text-muted">Минимальная сумма: 100 руб.</small>
                                        </div>
                                        <div class="quick-amounts d-flex flex-wrap gap-2 mt-3">
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="robokassa-amount" data-amount="500">500 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="robokassa-amount" data-amount="1000">1 000 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="robokassa-amount" data-amount="2000">2 000 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="robokassa-amount" data-amount="5000">5 000 ₽
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- YooKassa Form -->
                                <div class="tab-pane fade" id="yookassa" role="tabpanel" aria-labelledby="yookassa-tab">
                                    <div class="alert alert-info mb-4">
                                        <p class="mb-0">Удобный способ оплаты с поддержкой всех
                                            основных банковских карт и платёжных систем. Мгновенное зачисление средств.
                                            Система автоматически добавит комиссию 10% к указанной вами сумме.</p>
                                    </div>
                                    <form id="yookassa-form" data-url="{% url 'payments:yookassa_initiate' %}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="yookassa-amount" class="form-label fw-bold">Сумма пополнения
                                                (руб.)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="yookassa-amount" min="100"
                                                       step="100" placeholder="Например, 1000" required>
                                                <button type="submit" class="btn btn-primary">Пополнить
                                                </button>
                                            </div>
                                            <small class="text-muted">Минимальная сумма: 100 руб.</small>
                                        </div>
                                        <div class="quick-amounts d-flex flex-wrap gap-2 mt-3">
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="yookassa-amount" data-amount="500">500 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="yookassa-amount" data-amount="1000">1 000 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="yookassa-amount" data-amount="2000">2 000 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="yookassa-amount" data-amount="5000">5 000 ₽
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- heleket (Crypto) Form -->
                                <div class="tab-pane fade" id="heleket" role="tabpanel" aria-labelledby="heleket-tab">
                                    <div class="alert alert-info mb-4">
                                        <p class="mb-0">Оплата криптовалютой. Поддерживаются
                                            основные криптовалюты (BTC, ETH, USDT и др.). Система автоматически добавит
                                            комиссию 6% к указанной вами сумме.</p>
                                    </div>
                                    <form id="heleket-form" data-url="{% url 'payments:heleket_initiate' %}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="heleket-amount" class="form-label fw-bold">Сумма пополнения
                                                (руб.)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="heleket-amount" min="500"
                                                       step="100" placeholder="Например, 1000" required>
                                                <button type="submit" class="btn btn-primary">Пополнить
                                                </button>
                                            </div>
                                            <small class="text-muted">Минимальная сумма: 500 руб.</small>
                                        </div>
                                        <div class="quick-amounts d-flex flex-wrap gap-2 mt-3">
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="heleket-amount" data-amount="500">500 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="heleket-amount" data-amount="1000">1 000 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="heleket-amount" data-amount="2000">2 000 ₽
                                            </button>
                                            <button type="button" class="btn btn-outline-primary amount-btn"
                                                    data-target="heleket-amount" data-amount="5000">5 000 ₽
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Sections -->
            <div class="row mt-5">
                <!-- Vehicle Reports History -->
                <div class="col-lg-10 mx-auto mb-5">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h2 class="section-heading mb-4">История запросов</h2>
                            <div class="table-responsive">
                                <table class="table payment-history-table">
                                    <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>VIN</th>
                                        <th>Марка</th>
                                        <th>Тип запроса</th>
                                        <th>Стоимость</th>
                                    </tr>
                                    </thead>
                                    <tbody id="queries-table" data-url="{% url 'reports:user_queries' %}">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Загрузка...</span>
                                            </div>
                                            <span class="ms-2">Загрузка истории запросов...</span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment History -->
                <div class="col-lg-10 mx-auto">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h2 class="section-heading mb-4">История пополнений</h2>
                            
                            {% if payments %}
                                <div class="table-responsive">
                                    <table class="table payment-history-table">
                                        <thead>
                                            <tr>
                                                <th>Дата</th>
                                                <th>Сумма</th>
                                                <th>Статус</th>
                                                <th>Способ оплаты</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for payment in payments %}
                                                <tr>
                                                    <td>{{ payment.created_at|date:"d.m.Y H:i" }}</td>
                                                    <td>{{ payment.amount|floatformat:2 }} руб.</td>
                                                    <td>
                                                        <span class="payment-status-badge 
                                                            {% if payment.status == 'success' %}badge-success
                                                            {% elif payment.status == 'pending' %}badge-pending
                                                            {% else %}badge-failed{% endif %}">
                                                            {% if payment.status == 'success' %}Успешно
                                                            {% elif payment.status == 'pending' %}В обработке
                                                            {% else %}Отклонено{% endif %}
                                                        </span>
                                                    </td>
                                                    <td>{{ payment.provider|title }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state p-4 text-center">
                                    <div class="empty-state-icon mb-3">
                                        <i class="fas fa-receipt fa-3x text-muted"></i>
                                    </div>
                                    <h3 class="empty-state-title">Нет истории платежей</h3>
                                    <p class="empty-state-description">Пополните баланс, чтобы увидеть историю платежей</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %} 